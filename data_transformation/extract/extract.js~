
var jsdom = require("jsdom");
var fs = require('fs');

var baseUrl='http://localhost:9000/';
var projectUrl;

var writeStream = fs.createWriteStream("metrics.csv");
start();

function start(){

  inspectWeb(baseUrl,function($){
    var header="project name,"+
    "version,"+
    "date,"+
    "lines of code,"+
    "complexity,"+
    "comment lines density%,"+
    "duplicated lines density%,"+
    "issues,"+
    "complexity/file,"+
    "complexity/function,"+
    "comment lines,"+
    "duplicated blocks,"+
    "blocker issues,"+
    "critical issues,"+
    "major issues,"+
    "minor issues,"+
    "directories,"+
    "functions,"+
    "statements,"+
    "SQALE rating,"+
    "technical debt,"+
    "technical debt ratio"+
     "\n";
    writeStream.write(header);
    $("#measures-table").find('tbody').find('tr a').each(function(){
      inspectWithinEachProject( $(this).attr('title'),$(this).attr('href'));
    });

  });
  }

function inspectWithinEachProject(projectName,projectUrl){
//  console.log('Project Name:'+ projectName+' | '+ projectUrl);
  inspectWeb('http://localhost:9000/comparison/index?resource='+projectName,function($){

    var sids=$("#sids").attr('value');
    var customizedUrl=baseUrl+'comparison/index?sids='+sids+'&metrics=ncloc%2Ccomplexity%2Ccomment_lines_density%2Cduplicated_lines_density%2Cviolations%2Cfile_complexity%2Cfunction_complexity%2Ccomment_lines%2Cduplicated_blocks%2Cblocker_violations%2Ccritical_violations%2Cmajor_violations%2Cminor_violations%2Cdirectories%2Cfunctions%2Cstatements%2Csqale_rating%2Csqale_index%2Csqale_debt_ratio';

    // Actual page for extracting data
    inspectWeb(customizedUrl,function($){
      console.log(customizedUrl+'\n');
      var table=$(".data");
      var numberOfVersions=table.find('thead').find('tr#resource-info-header').find('th');

      for (var index=1;index<numberOfVersions.size()-1;index++){
        var spans=$(numberOfVersions[index]).find('span>span');
          var versionNumber=spans.first().text();
          var versionDate=spans.last().text();
          var lineToWrite=projectName+','+versionNumber+','+versionDate;
          console.log('version number:'+versionNumber+' and version date:'+ versionDate);
          //extract data from each column
var rowNumber=0;
          table.tbody('find').find('tr').each(function(){
            $(this).find('span').each(function(innerIndex){
              //console.log('index:'+index);
            //  console.log('inner index:'+innerIndex);
              if (index==(innerIndex+1))
              {
                var metricValue=$(this).text();
                lineToWrite+=','+metricValue;
              }
            })
          });
          writeStream.write(lineToWrite+"\n");
      }
    });
  });
}

function inspectWeb(conf_url, callback){
  jsdom.env({
    url:conf_url,
    scripts: ["http://code.jquery.com/jquery.js"],
    done: function (errors, window) {
      var $ = window.$;
      callback($);
    }
  });
}
